var tempCsData=[];function view(){var o=this;this.CsData=[];this.CsID=0;this.ItemCount=0;this.CurrentItemNum=1;this.isClick=1;this.init=function(){return o};this.start=function(_csid,_itemcount){if(_csid>0&&_itemcount>0){o.CsID=_csid;o.ItemCount=_itemcount;var _cspage=$("#ceshi-page");var _csform=$("#ceshi-form");_cspage.hide();$("#copyright").hide();o.head(_csform,_cspage);_csform.find(".ceshi-contexts").eq(0).show();o.loadSelectClick(0);o.scroll()}else{o.jalert("测试数据异常，请联系网站管理员处理")}};this.scroll=function(){$("html, body").animate({scrollTop:0},320)};this.head=function(_csform,_cspage){var _csformhead='<div id="ceshi-head"><p class="ceshi-tit"></p><div class="ceshi-des">您正在做测试<i class="des">'+o.CurrentItemNum+"/"+o.ItemCount+'题</i><p class="proc-line"></p></div></div>';_csform.prepend(_csformhead);_csform.show().find("#ceshi-head>.ceshi-tit").text(_cspage.find(".htop>.title>span>b").text())};this.updateProc=function(){var _speed=(o.CurrentItemNum-1)/o.ItemCount;_speed=parseInt(_speed*100);if(_speed>0){o.CurrentItemNum=o.CurrentItemNum>o.ItemCount?o.ItemCount:o.CurrentItemNum;var _shtml='您正在做测试，已完成<i class="proc-num">'+_speed+'%</i><i class="des">'+o.CurrentItemNum+"/"+o.ItemCount+'题</i><p class="proc-line"></p>';var _csform=$("#ceshi-form");_csform.find("#ceshi-head>.ceshi-des").html(_shtml);_csform.find("#ceshi-head>.ceshi-des>.proc-line").css("width",_speed+"%")}};this.loadSelectClick=function(StartIndex){var _ceshiform=$("#ceshi-form>.ceshi-contexts");var _quelist=StartIndex==0?_ceshiform:_ceshiform.eq(StartIndex-1).nextAll();if(_quelist.find(".questions").length>0){_quelist.find(".nextbtn>a").click(function(){if(o.isClick==1){o.isClick=0;var _this=$(this).parent().parent().find(".questions>ul>li>input");var _name=_this.eq(0).attr("name").split("_");var _itemID=_name[1];var _itemNum=_name[2];var _selectValue=[];$(":checkbox[name='"+_this.eq(0).attr("name")+"']:checked").each(function(i){_selectValue[i]=this.value});_selectValue=_selectValue.join(",");if(_selectValue==""){o.jalert("请先答题")}else{o.add(_itemNum,_itemID,_selectValue);o.Next(_itemNum,_selectValue)}}})}_quelist.find(".question>ul>li").click(function(){if(o.isClick==1){o.isClick=0;var _this=$(this).find("input");var _name=_this.attr("name").split("_");var _itemID=_name[1];var _itemNum=_name[2];var _selectValue=_this.val();_this.prop("checked",true);o.add(_itemNum,_itemID,_selectValue);o.Next(_itemNum,_selectValue);return false}})};this.Next=function(_itemNum,_selectValue){var questionObj=$("#question_"+_itemNum);var _next=parseInt(_itemNum)+1;var _isSubmitResult=false;var isGoto=false;if(_selectValue.indexOf("_")!=-1){var _splitSelect=_selectValue.split("_");_isSubmitResult=_splitSelect[0]==1?true:false;_next=_splitSelect[1];isGoto=true}else{_isSubmitResult=_next>o.ItemCount?true:false}var _nextObj=$("#question_"+_next);if(_isSubmitResult){o.amimate(questionObj,function(){questionObj.hide();o.isClick=1;questionObj.after('<p class="wait"><i>拼命计算中...</i>客官别急，测试结果即将出来</p>');o.submit($(".wait"),null,(isGoto?1:0),_next)})}else{o.amimate(questionObj,function(){questionObj.hide();o.isClick=1;if(_nextObj.length<=0){$("#ceshi-form").append('<div class="ceshi-contexts" id="question_fail"><i>您的网络异常，数据加载失败！<br />请在稳定的网络环境下继续测试</i><a href="javascript:void(0);" onclick="_view.continueCs(this,'+_next+')">继续测试</a></div>');$("#question_fail").fadeIn().show()}else{_nextObj.fadeIn().show()}})}if(_nextObj.length>0){o.CurrentItemNum=_next;o.updateProc()}if(!isGoto){o.loadItemData()}};this.continueCs=function(obj,_next){var _this=$(obj);var oldClick=_this.attr("onclick");var start=$("#ceshi-form>.ceshi-contexts").length-1;var _list=$("#ceshi-form");glb.ajax(glb.ajaxUrl+"loadcsitemlist","html","start="+start+"&CsID="+o.CsID,function(){_this.attr("onclick","").text("正在加载，请稍候")},function(data){$("#question_fail").remove();_list.append(data);o.loadSelectClick(start);o.isClick=1;$("#question_"+_next).fadeIn().show();o.CurrentItemNum=_next;o.updateProc()},function(){o.jalert("数据加载失败，请检查您的网络是否正常？");_this.attr("onclick",oldClick).text("继续测试")})};this.loadItemData=function(){var _currentItems=$("#ceshi-form>.ceshi-contexts").length;if(_currentItems<o.ItemCount){var start=_currentItems;o.loadItem(start,o.CsID)}};this.amimate=function(obj,fn){obj.animate({left:"-100%",opacity:"0.5"},300,null,fn)};this.add=function(itemNum,itemID,selectValue){var _itemValue=itemID+"_"+itemNum+"@"+selectValue;if(o.checkAdd(_itemValue)){o.CsData[itemNum-1]=_itemValue;tempCsData=o.CsData}};this.checkAdd=function(itemValue){var v=true;var len=o.CsData.length;if(len>0){for(var i=0;i<len;i++){if(o.CsData[i]==itemValue){v=false;break}}}return v};this.submit=function(_wait,obj,isGoto,_next){var _this=$(obj);var csResult=isGoto==1?_next:o.CsData.join("|");var _wait=_wait==null?_this.parent():_wait;glb.ajax(glb.ajaxUrl+"submitcsresult","JSON","CsID="+o.CsID+"&CsResult="+csResult,function(){if(obj!=null){_wait.html("<i>拼命计算中...</i>客官别急，测试结果即将出来")}},function(data){var d=eval(data);if(d.status==1){var _resultUrl="/ceshi/result/"+d.ResultID+".html";tempCsData=[];_wait.html("<i>提交计算成功</i>正在自动跳转至结果页...");setTimeout(function(){_wait.html('<i>提交计算成功</i>您当前网络环境不稳定，建议手动点击查看测试结果<a href="'+_resultUrl+'">查看测试结果</a>')},5000);location.href=_resultUrl}else{_wait.html("<i>您的网络异常</i>提交计算失败，请在稳定的网络环境下重新提交<br />ErrorCode:"+d.ResultID+'<br /><a href="javascript:void(0);" onclick="_view.submit(null,this,'+isGoto+","+_next+')">重新提交</a>');if(obj!=null){o.jalert("提交计算失败，请检查您的网络是否正常？")}}},function(){_wait.html('<i>您的网络异常</i>提交计算失败，请在稳定的网络环境下重新提交<br /><a href="javascript:void(0);" onclick="_view.submit(null,this,'+isGoto+","+_next+')">重新提交</a>');if(obj!=null){o.jalert("提交计算失败，请检查您的网络是否正常？")}})};this.loadItem=function(start,csid){var _list=$("#ceshi-form");glb.ajax(glb.ajaxUrl+"loadcsitemlist","html","start="+start+"&CsID="+csid,null,function(data){_list.find(".no").remove();_list.append(data);o.loadSelectClick(start)},null)};this.jalert=function(info){$.jalerttimer("操作提示",info,"auto",function(){$.jfnclose()},null)}}var _view=null;var _commenton=null;var _favorites=null;$(function(){_commenton=new commentOn().init();_favorites=new favorites().init();_view=new view().init()});$(window).on("beforeunload ",function(){if(tempCsData.length>0){return"您本次测试尚未做完，退出将导致测试数据丢失，下次再做？"}});